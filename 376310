import os
import sqlite3
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Updater,
    CommandHandler,
    CallbackQueryHandler,
    CallbackContext,
    MessageHandler,
    Filters
)
from datetime import datetime, timedelta

# ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø² Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ø¯
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ SQLite
conn = sqlite3.connect('investment_bot.db', check_same_thread=False)
cursor = conn.cursor()

# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª
cursor.execute('''
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    username TEXT,
    first_name TEXT,
    invest_plan_id INTEGER,
    invest_amount REAL,
    invest_start_date TEXT,
    last_withdraw_date TEXT,
    balance REAL DEFAULT 0,
    total_profit REAL DEFAULT 0,
    is_admin INTEGER DEFAULT 0
)
''')
conn.commit()

# ØªØ¹Ø±ÛŒÙ Ø·Ø±Ø­â€ŒÙ‡Ø§
INVESTMENT_PLANS = [
    {"id": 1, "name": "Ø·Ø±Ø­ Û±", "amount": 17, "daily": 1, "days": 50},
    {"id": 2, "name": "Ø·Ø±Ø­ Û²", "amount": 50, "daily": 2, "days": 48},
    {"id": 3, "name": "Ø·Ø±Ø­ Û³", "amount": 100, "daily": 3, "days": 64},
    {"id": 4, "name": "Ø·Ø±Ø­ Û´", "amount": 180, "daily": 9, "days": 50}
]

# Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ USDT
WALLET_ADDRESS = "0xYourWalletAddressHere"

def is_admin(user_id):
    cursor.execute('SELECT is_admin FROM users WHERE user_id = ?', (user_id,))
    row = cursor.fetchone()
    return row and row[0] == 1

def add_user(user):
    cursor.execute('SELECT user_id FROM users WHERE user_id = ?', (user.id,))
    if cursor.fetchone() is None:
        cursor.execute('INSERT INTO users (user_id, username, first_name) VALUES (?, ?, ?)',
                       (user.id, user.username, user.first_name))
        conn.commit()

def start(update: Update, context: CallbackContext):
    user = update.effective_user
    add_user(user)
    
    keyboard = [
        [InlineKeyboardButton("ğŸ“Š Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ", callback_data='plans')],
        [InlineKeyboardButton("ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…Ù†", callback_data='wallet')],
        [InlineKeyboardButton("ğŸ’³ ÙˆØ§Ø±ÛŒØ² ÙˆØ¬Ù‡", callback_data='deposit')],
        [InlineKeyboardButton("ğŸ“¤ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª", callback_data='withdraw')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    update.message.reply_text(
        f"Ø³Ù„Ø§Ù… {user.first_name} ğŸ‘‹\n"
        "Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\n"
        "Ù„Ø·ÙØ§ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=reply_markup
    )

def show_plans(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    
    keyboard = []
    for plan in INVESTMENT_PLANS:
        keyboard.append([
            InlineKeyboardButton(
                f"{plan['name']}: Ø³Ø±Ù…Ø§ÛŒÙ‡ {plan['amount']}$ â†’ Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ {plan['daily']}$ Ø¨Ø±Ø§ÛŒ {plan['days']} Ø±ÙˆØ²",
                callback_data=f"plan_{plan['id']}"
            )
        ])
    
    keyboard.append([InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data='back')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    query.edit_message_text(
        text="ğŸ“Š Ø·Ø±Ø­â€ŒÙ‡Ø§ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯:",
        reply_markup=reply_markup
    )

def show_deposit(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    
    keyboard = [[InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data='back')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    query.edit_message_text(
        text=f"ğŸ’° Ø¨Ø±Ø§ÛŒ ÙˆØ§Ø±ÛŒØ² ÙˆØ¬Ù‡ Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n"
             f"Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„: `{WALLET_ADDRESS}`\n\n"
             f"âš ï¸ ØªÙˆØ¬Ù‡: ÙÙ‚Ø· Ø§Ø±Ø² USDT (Ø´Ø¨Ú©Ù‡ ERC20) Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ø³Øª.\n"
             f"Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ø±Ø³ÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

def button_handler(update: Update, context: CallbackContext):
    query = update.callback_query
    data = query.data
    
    if data == 'plans':
        show_plans(update, context)
    elif data == 'deposit':
        show_deposit(update, context)
    elif data == 'back':
        start(update, context)
    elif data.startswith('plan_'):
        plan_id = int(data.split('_')[1])
        show_plan_details(update, context, plan_id)
    elif data.startswith('select_'):
        plan_id = int(data.split('_')[1])
        select_plan(update, context, plan_id)
    elif data == 'wallet':
        show_wallet(update, context)
    elif data == 'withdraw':
        request_withdraw(update, context)

def show_plan_details(update: Update, context: CallbackContext, plan_id: int):
    query = update.callback_query
    plan = next(p for p in INVESTMENT_PLANS if p['id'] == plan_id)
    
    keyboard = [
        [InlineKeyboardButton("âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÛŒÙ† Ø·Ø±Ø­", callback_data=f'select_{plan_id}')],
        [InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data='plans')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    query.edit_message_text(
        text=f"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø·Ø±Ø­ {plan['name']}:\n\n"
             f"ğŸ’µ Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: {plan['amount']} $\n"
             f"ğŸ’° Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡: {plan['daily']} $\n"
             f"ğŸ“… Ù…Ø¯Øª Ø²Ù…Ø§Ù†: {plan['days']} Ø±ÙˆØ²\n"
             f"ğŸ’¸ Ø³ÙˆØ¯ Ú©Ù„: {plan['daily'] * plan['days']} $\n\n"
             f"Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÛŒÙ† Ø·Ø±Ø­ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:",
        reply_markup=reply_markup
    )

def select_plan(update: Update, context: CallbackContext, plan_id: int):
    user_id = update.effective_user.id
    plan = next(p for p in INVESTMENT_PLANS if p['id'] == plan_id)
    
    cursor.execute('''
        UPDATE users
        SET invest_plan_id = ?, invest_amount = ?, invest_start_date = ?
        WHERE user_id = ?
    ''', (plan_id, plan['amount'], datetime.now().strftime('%Y-%m-%d'), user_id))
    conn.commit()
    
    update.callback_query.answer(text="Ø·Ø±Ø­ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯! Ù„Ø·ÙØ§ ÙˆØ¬Ù‡ Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯.")
    update.callback_query.edit_message_text(
        text=f"âœ… Ø´Ù…Ø§ Ø·Ø±Ø­ {plan['name']} Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒØ¯.\n"
             f"Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: {plan['amount']} Ø¯Ù„Ø§Ø±\n"
             f"Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯:\n"
             f"{WALLET_ADDRESS}"
    )

def show_wallet(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    cursor.execute('SELECT invest_plan_id, invest_amount, invest_start_date, balance, total_profit FROM users WHERE user_id = ?', (user_id,))
    row = cursor.fetchone()
    if row is None or row[0] is None:
        text = "Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø·Ø±Ø­ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯."
    else:
        plan = next(p for p in INVESTMENT_PLANS if p['id'] == row[0])
        invest_date = datetime.strptime(row[2], '%Y-%m-%d')
        days_passed = (datetime.now() - invest_date).days
        days_passed = min(days_passed, plan['days'])
        earned = days_passed * plan['daily']
        text = (f"ğŸ’¼ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø´Ù…Ø§:\n\n"
                f"Ø·Ø±Ø­: {plan['name']}\n"
                f"Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡: {row[1]} Ø¯Ù„Ø§Ø±\n"
                f"ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹: {row[2]}\n"
                f"Ù…Ø¯Øª Ú¯Ø°Ø´Øª: {days_passed} Ø±ÙˆØ²\n"
                f"Ø³ÙˆØ¯ Ú©Ø³Ø¨ Ø´Ø¯Ù‡: {earned} Ø¯Ù„Ø§Ø±\n"
                f"Ù…Ø§Ù†Ø¯Ù‡ Ø³ÙˆØ¯ Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª: {row[3]} Ø¯Ù„Ø§Ø±\n"
                f"Ú©Ù„ Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡: {row[4]} Ø¯Ù„Ø§Ø±\n"
               )
    update.callback_query.answer()
    update.callback_query.edit_message_text(text=text)

def request_withdraw(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    cursor.execute('SELECT balance FROM users WHERE user_id = ?', (user_id,))
    row = cursor.fetchone()
    if row is None or row[0] is None or row[0] <= 0:
        update.callback_query.answer(text="Ø´Ù…Ø§ Ù‡ÛŒÚ† Ø³ÙˆØ¯ Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ù†Ø¯Ø§Ø±ÛŒØ¯.")
        return
    
    keyboard = [
        [InlineKeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª", callback_data='confirm_withdraw')],
        [InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data='wallet')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    update.callback_query.answer()
    update.callback_query.edit_message_text(
        text=f"ğŸ’° Ø´Ù…Ø§ {row[0]} Ø¯Ù„Ø§Ø± Ø³ÙˆØ¯ Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¯Ø§Ø±ÛŒØ¯.\nØ¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ØŸ",
        reply_markup=reply_markup
    )

def confirm_withdraw(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    cursor.execute('SELECT balance FROM users WHERE user_id = ?', (user_id,))
    row = cursor.fetchone()
    if row is None or row[0] is None or row[0] <= 0:
        update.callback_query.answer(text="Ø³ÙˆØ¯ Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.")
        return
    
    # Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ùˆ ÛŒØ§ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯ (Ú©Ø¯ Ù†Ù…ÙˆÙ†Ù‡ Ø³Ø§Ø¯Ù‡)
    cursor.execute('UPDATE users SET balance = 0, total_profit = total_profit + ? WHERE user_id = ?', (row[0], user_id))
    conn.commit()
    
    update.callback_query.answer(text="Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ø«Ø¨Øª Ø´Ø¯. Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
    update.callback_query.edit_message_text(text="âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.")

def main():
    updater = Updater(TOKEN)
    dispatcher = updater.dispatcher
    
    dispatcher.add_handler(CommandHandler('start', start))
    dispatcher.add_handler(CallbackQueryHandler(button_handler))
    
    # Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø¯Ø§Ø´Øª
    dispatcher.add_handler(CallbackQueryHandler(confirm_withdraw, pattern='confirm_withdraw'))
    
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()